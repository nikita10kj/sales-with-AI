{% extends 'users/base.html' %}
{% block content %}
<style>
    .chart-card {
      height: 400px;
    }
    canvas {
      width: 100% !important;
      height: 300px !important;
    }
  </style>
        
            <!-- Main Content -->
            <div class="main-content-analytics">
                <!-- Overview Section -->
                <div class="analytics-section active" id="overview">


                    <!-- Key Metrics Cards -->
                <div class="row g-4 mb-2">
                <!-- Emails Sent Card -->
                <div class="col-md-6">
                    <div class="d-flex align-items-center p-4 rounded-4 shadow" 
                        style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 10px 30px rgba(16, 172, 132, 0.15); transition: transform 0.4s ease;" 
                        onmouseover="this.style.transform='scale(1.03)'" 
                        onmouseout="this.style.transform='scale(1)'">
                    <div class="d-flex align-items-center justify-content-center me-4" 
                        style="width: 80px; height: 80px; border-radius: 20px; background: linear-gradient(145deg, #00b894, #55efc4); box-shadow: 0 6px 15px rgba(0, 184, 148, 0.4);">
                        <i class="fas fa-paper-plane text-white" style="font-size: 2rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                    <!-- Total Sent -->
                    <h3 class="mb-1 fw-bold" style="font-size: 2.4rem; color: #2c3e50;">
                    {{ total_sent }}
                    </h3>
                    <p class="text-muted mb-2" style="font-size: 0.95rem;">Total Emails Sent</p>

                    <!-- Breakdown -->
                    <div class=" mt-3 small text-muted" style="font-size: 0.85rem;">
                        <div class="d-flex gap-4 mb-1">
                        <div>üìÖ <strong>Today:</strong> {{ today_sent }}</div>
                        <div>‚è™ <strong>Yesterday:</strong> {{ yesterday_sent }}</div>
                    </div>

                    <div class="d-flex gap-4">
                        <div>üìä <strong>Last Week:</strong> {{ last_week_sent }}</div>
                        <div>üóìÔ∏è <strong>Last Month:</strong> {{ last_month_sent }}</div>
                    </div>
                    </div>

                    {% if email_limit %}
                    <div class="mt-2 fw-semibold"
                        style="font-size: 0.75rem;
                                color: {% if remaining_emails <= 50 %}#dc3545{% else %}#00b894{% endif %};">
                    {{ remaining_emails }} left out of {{ email_limit }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

  <!-- Open Rate Card -->
  <div class="col-md-6">
    <div class="d-flex align-items-center p-4 rounded-4 shadow" 
         style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 10px 30px rgba(41, 128, 185, 0.15); transition: transform 0.4s ease;" 
         onmouseover="this.style.transform='scale(1.03)'" 
         onmouseout="this.style.transform='scale(1)'">
      <div class="d-flex align-items-center justify-content-center me-4" 
           style="width: 80px; height: 80px; border-radius: 20px; background: linear-gradient(145deg, #0984e3, #74b9ff); box-shadow: 0 6px 15px rgba(9, 132, 227, 0.4);">
        <i class="fas fa-envelope-open text-white" style="font-size: 2rem;"></i>
      </div>
      <div>
        <h3 id="openRate" class="mb-1 fw-bold" style="font-size: 2.5rem; color: #2c3e50;">{{ open_rate }}%</h3>
        <p class="text-muted mb-3" style="font-size: 0.95rem;">Open Rate</p>
        <div class="d-flex flex-column gap-1 mt-2" style="font-size: 0.85rem;">
            <span>
                <strong>Today:</strong> {{ today_opened}}
                <span class="text-danger">({{ unread_percentage }}%)</span>
            </span>
            <span>
                <strong>Read:</strong> {{ read_emails }}
                <span class="text-success">({{ read_percentage }}%)</span>
            </span>
            <span>
                <strong>Unread:</strong> {{ unread_emails }}
                <span class="text-danger">({{ unread_percentage }}%)</span>
            </span>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
</div>                    
</div>

                    <!-- Charts Row -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="chart-card">
                                <div class="chart-header">
                                    <h5><i class="fas fa-chart-line me-2"></i>Email Performance Trends</h5>
                                    <div class="chart-controls mt-3">
                                        <button class="btn btn-sm btn-outline-secondary active" data-metric="all">All</button>
                                        <button class="btn btn-sm btn-outline-secondary" data-metric="sent">Sent</button>
                                        <button class="btn btn-sm btn-outline-secondary" data-metric="opened">Opened</button>
                                    </div>
                                </div>
                                <canvas id="performanceChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="activity-card">
                                <div class="card-header">
                                    <h5><i class="fas fa-clock me-2"></i>Recent Activity</h5>
                                </div>
                                <div class="activity-list">
                                    {% for activity in recent_activities %}
                                        <div class="activity-item">
                                            {% if activity.action == 'EMAIL_SENT' %}
                                                <div class="activity-icon bg-success">
                                                    <i class="fas fa-paper-plane"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <p><strong>{{ activity.description|default:"Email sent" }}</strong></p>
                                                    <small class="text-muted">{{ activity.timestamp|timesince }} ago</small>
                                                </div>
                                            {% elif activity.action == 'EMAIL_OPENED' %}
                                                <div class="activity-icon bg-info">
                                                    <i class="fas fa-envelope-open"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <p><strong>{{ activity.description|default:"Email opened" }}</strong></p>
                                                    <small class="text-muted">{{ activity.timestamp|timesince }} ago</small>
                                                </div>
                                            {% elif activity.action == 'PROFILE_UPDATED' %}
                                                <div class="activity-icon bg-primary">
                                                    <i class="fas fa-user-edit"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <p><strong>{{ activity.description|default:"Profile updated" }}</strong></p>
                                                    <small class="text-muted">{{ activity.timestamp|timesince }} ago</small>
                                                </div>
                                            {% else %}
                                                <div class="activity-icon bg-secondary">
                                                    <i class="fas fa-bell"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <p><strong>{{ activity.action }}</strong></p>
                                                    <p>{{ activity.description|default:"" }}</p>
                                                    <small class="text-muted">{{ activity.timestamp|timesince }} ago</small>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% empty %}
                                        <div class="activity-item">
                                            <div class="activity-content">
                                                <p>No recent activities found</p>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="top-performers-card">
                                <div class="card-header">
                                    <h5><i class="fas fa-trophy me-2"></i>Top Performing Frameworks</h5>
                                </div>
                                <div class="performers-list">
                                    {% for campaign in top_campaigns %}
                                    <div class="performer-item">
                                        <div class="performer-rank">{{ campaign.rank }}</div>
                                        <div class="performer-content">
                                            <h6>{{ campaign.framework }} - {{ campaign.service }}</h6>
                                            <div class="performer-stats">
                                                <span class="stat">Open: {{ campaign.open_rate }}%</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="performer-item">
                                        <div class="performer-content">
                                            <h6>No campaign data available</h6>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campaigns Section -->
                <div class="analytics-section" id="campaigns">
                    <div class="section-header">
                        <h2><i class="fas fa-envelope-open me-2"></i>Campaign Analytics</h2>
                        <button class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>New Campaign
                        </button>
                    </div>

                    <div class="campaigns-table-card">
                        <div class="table-controls">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" class="form-control" placeholder="Search campaigns...">
                            </div>
                            <div class="filter-controls">
                                <select class="form-select">
                                    <option>All Campaigns</option>
                                    <option>Active</option>
                                    <option>Completed</option>
                                    <option>Draft</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table campaigns-table">
                                <thead>
                                    <tr>
                                        <th>Campaign Name</th>
                                        <th>Framework</th>
                                        <th>Sent</th>
                                        <th>Open Rate</th>
                                        <th>Click Rate</th>
                                        <th>Response Rate</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>``
                                </thead>
                                <tbody id="campaignsTableBody">
                                    <!-- Campaign rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Performance Section -->
                <div class="analytics-section" id="performance">
                    <div class="section-header">
                        <h2><i class="fas fa-chart-line me-2"></i>Performance Analysis</h2>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="chart-card">
                                <div class="chart-header">
                                    <h5><i class="fas fa-chart-bar me-2"></i>Framework Performance</h5>
                                </div>
                                <canvas id="frameworkChart" height="300"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-card">
                                <div class="chart-header">
                                    <h5><i class="fas fa-clock me-2"></i>Best Send Times</h5>
                                </div>
                                <canvas id="sendTimesChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="heatmap-card">
                                <div class="card-header">
                                    <h5><i class="fas fa-calendar-alt me-2"></i>Email Activity Heatmap</h5>
                                </div>
                                <div class="heatmap-container">
                                    <div class="heatmap-legend">
                                        <span>Less</span>
                                        <div class="legend-scale">
                                            <div class="scale-item" data-level="0"></div>
                                            <div class="scale-item" data-level="1"></div>
                                            <div class="scale-item" data-level="2"></div>
                                            <div class="scale-item" data-level="3"></div>
                                            <div class="scale-item" data-level="4"></div>
                                        </div>
                                        <span>More</span>
                                    </div>
                                    <div id="activityHeatmap"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audience Section -->
                <div class="analytics-section" id="audience">
                    <div class="section-header">
                        <h2><i class="fas fa-users me-2"></i>Audience Insights</h2>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="audience-metric-card">
                                <div class="metric-header">
                                    <h5>Total Contacts</h5>
                                    <i class="fas fa-address-book"></i>
                                </div>
                                <div class="metric-value">2,847</div>
                                <div class="metric-subtitle">+127 this month</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="audience-metric-card">
                                <div class="metric-header">
                                    <h5>Active Subscribers</h5>
                                    <i class="fas fa-user-check"></i>
                                </div>
                                <div class="metric-value">2,341</div>
                                <div class="metric-subtitle">82.2% of total</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="audience-metric-card">
                                <div class="metric-header">
                                    <h5>Avg. Engagement</h5>
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="metric-value">67.3%</div>
                                <div class="metric-subtitle">+5.1% vs last month</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-card">
                                <div class="chart-header">
                                    <h5><i class="fas fa-industry me-2"></i>Industry Breakdown</h5>
                                </div>
                                <canvas id="industryChart" height="300"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-card">
                                <div class="chart-header">
                                    <h5><i class="fas fa-building me-2"></i>Company Size Distribution</h5>
                                </div>
                                <canvas id="companySizeChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div class="analytics-section" id="reports">
                    <div class="section-header">
                        <h2><i class="fas fa-file-alt me-2"></i>Reports & Exports</h2>
                        <button class="btn btn-success">
                            <i class="fas fa-download me-2"></i>Export All Data
                        </button>
                    </div>

                    <div class="reports-grid">
                        <div class="report-card">
                            <div class="report-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="report-content">
                                <h5>Performance Report</h5>
                                <p>Comprehensive analysis of all campaign metrics</p>
                                <button class="btn btn-outline-primary">Generate Report</button>
                            </div>
                        </div>
                        <div class="report-card">
                            <div class="report-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="report-content">
                                <h5>Audience Report</h5>
                                <p>Detailed breakdown of your contact database</p>
                                <button class="btn btn-outline-primary">Generate Report</button>
                            </div>
                        </div>
                        <div class="report-card">
                            <div class="report-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="report-content">
                                <h5>Campaign Summary</h5>
                                <p>Individual campaign performance analysis</p>
                                <button class="btn btn-outline-primary">Generate Report</button>
                            </div>
                        </div>
                        <div class="report-card">
                            <div class="report-icon">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div class="report-content">
                                <h5>Monthly Report</h5>
                                <p>Month-over-month performance comparison</p>
                                <button class="btn btn-outline-primary">Generate Report</button>
                            </div>
                        </div>
                    </div>

                    <div class="export-options">
                        <h5>Export Options</h5>
                        <div class="export-formats">
                            <button class="btn btn-outline-secondary">
                                <i class="fas fa-file-csv me-2"></i>CSV
                            </button>
                            <button class="btn btn-outline-secondary">
                                <i class="fas fa-file-excel me-2"></i>Excel
                            </button>
                            <button class="btn btn-outline-secondary">
                                <i class="fas fa-file-pdf me-2"></i>PDF
                            </button>
                            <button class="btn btn-outline-secondary">
                                <i class="fas fa-file-code me-2"></i>JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
      // Performance Chart
      const ctx1 = document.getElementById("performanceChart").getContext("2d");
      const performanceChart = new Chart(ctx1, {
        type: "line",
        data: {
          labels: {{ chart_labels|safe }},
          datasets: [
            {
              label: "Emails Sent",
              data: {{ sent_data|safe }},
              borderColor: "#6f42c1",
              backgroundColor: "rgba(111, 66, 193, 0.1)",
              tension: 0.4,
              fill: true,
            },
            {
              label: "Emails Opened",
              data: {{ opened_data|safe }},
              borderColor: "#198754",
              backgroundColor: "rgba(25, 135, 84, 0.1)",
              tension: 0.4,
              fill: true,
            }
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { 
              position: 'top',
            },
            tooltip: {
              mode: 'index',
              intersect: false,
            }
          },
          scales: {
            y: { 
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Emails'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Date'
              }
            },
          },
        },
      });

      // Toggle between metrics
      document.querySelectorAll('[data-metric]').forEach(btn => {
        btn.addEventListener('click', function() {
          const metric = this.getAttribute('data-metric');
          document.querySelectorAll('[data-metric]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          performanceChart.data.datasets.forEach(dataset => {
            dataset.hidden = (metric === 'sent' && dataset.label.includes('Opened')) || 
                            (metric === 'opened' && dataset.label.includes('Sent'));
          });
          performanceChart.update();
        });
      });

      // Campaign Types Chart - Updated with real data
      const ctx2 = document.getElementById("campaignTypesChart").getContext("2d");
      new Chart(ctx2, {
        type: "doughnut",
        data: {
          labels: {{ campaign_labels|safe }},
          datasets: [{
            data: {{ campaign_counts|safe }},
            backgroundColor: [
              "#6f42c1", 
              "#198754", 
              "#ffc107", 
              "#dc3545",
              "#0dcaf0",
              "#fd7e14",
              "#20c997"
            ],
            borderWidth: 1,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                usePointStyle: true,
                padding: 20,
                font: {
                  size: 12
                }
              },
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          },
          cutout: '70%',
        },
      });
    });

</script>

<script>
function loadEmailStats() {
    fetch("{% url 'dashboard' %}")
        .then(res => res.json())
        .then(data => {
            document.getElementById("openRate").innerText = data.open_rate + "%";
            document.getElementById("todayOpened").innerText = data.today_opened;
            document.getElementById("readEmails").innerText = data.opened;
            document.getElementById("unreadEmails").innerText = data.unopened;
        });
}

// First load
loadEmailStats();

// Auto refresh every 10 seconds
setInterval(loadEmailStats, 10000);
</script>

{% endblock content %}
